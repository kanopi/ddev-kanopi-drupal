#!/usr/bin/env bash

## Description: Apply a Drupal Recipe.
## Usage: recipe-apply <recipe-path>
## Example: ddev recipe-apply ../recipes/recipe-name
## Example: ddev recipe-apply core/recipes/standard
## Aliases: recipe:apply,recipe,ra

#ddev-generated

# Abort if anything fails
set -e

# Check for help flag or no arguments
if [ "$1" = "--help" ] || [ "$1" = "-h" ] || [ -z "$1" ]; then
    echo -e "\n  📦  Apply a Drupal Recipe."
    echo -e "\n  🔹  Usage: ddev recipe-apply <recipe-path>"
    echo -e "\n  📖  Examples:"
    echo -e "      ddev recipe-apply ../recipes/recipe-name"
    echo -e "      ddev recipe-apply core/recipes/standard"
    echo -e "\n  🎯  This command applies a Drupal recipe and clears cache before and after."
    exit 0
fi

# Define the Drupal root inside DDEV
DOCROOT_PATH="/var/www/html/${DDEV_DOCROOT}"

# Ensure we're in the correct directory
cd "${DOCROOT_PATH}"

# Clear cache before applying the recipe
echo -e "\n 🧹  Clearing cache before applying recipe."
if command -v drush &> /dev/null; then
    drush cr
else
    echo "⚠️  Drush not available, skipping cache clear"
fi

# Apply the recipe
echo -e "\n 📦  Applying Drupal Recipe: $@"
php core/scripts/drupal recipe "$@"

# Clear cache again after applying the recipe
echo -e "\n 🧹  Clearing cache after applying recipe."
if command -v drush &> /dev/null; then
    drush cr
else
    echo "⚠️  Drush not available, skipping cache clear"
fi

echo -e "\n ✅  Recipe applied successfully!\n"
